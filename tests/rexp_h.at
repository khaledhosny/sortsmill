# -*- coding: utf-8 -*-

//-------------------------------------------------------------------------

m4_defun([check_rexp_h],
[
AT_SETUP([$1])
AT_KEYWORDS([auxiliary rexp.h unit rexp regex re regexp])
AT_SKIP_IF([test x${DOING_INSTALLCHECK} = xyes])
AT_SKIP_IF([test x"${posix_locale}" = x -o x"${posix_locale}" = xnone])
AT_CHECK_UNQUOTED([LC_ALL="${posix_locale}" "${abs_builddir}"/$1],[$2],[$3],[$4])
AT_CLEANUP
])

m4_defun([check_rexp_h_utf8],
[
AT_SETUP([$1])
AT_KEYWORDS([auxiliary rexp.h unit rexp regex re regexp])
AT_SKIP_IF([test x${DOING_INSTALLCHECK} = xyes])
AT_SKIP_IF([test x"${utf8_locale}" = xnone])
AT_CHECK_UNQUOTED([LC_ALL="${utf8_locale}" "${abs_builddir}"/$1],[$2],[$3],[$4])
AT_CLEANUP
])

//-------------------------------------------------------------------------

m4_foreach_w([test_program],[test_rexp_h test_rexp_h_u8],
[
m4_foreach_w([filter],[identity study jit
                       compile_study compile_jit
                       redo_study redo_jit
                       once_identity once_study once_jit
                       compile_once_study compile_once_jit
                       redo_once_study redo_once_jit],
[

# Do not test stderr for JIT cases, because we do not know whether the
# JIT is supported and succeeded.
m4_defun([stderr_text],[m4_defun([no_study_text],
[study: no
jit:   no
])m4_defun([study_text],
[study: yes
jit:   no
])m4_case([$1],
          [identity],[no_study_text],
          [study],[study_text],
          [compile_study],[study_text],
          [redo_study],[study_text],
          [once_identity],[no_study_text],
          [once_study],[study_text],
          [compile_once_study],[study_text],
          [redo_once_study],[study_text],
          [ignore])])

check_rexp_h([test_program 'broken[(]re' anything match filter],[10],[ignore],[ignore])
check_rexp_h([test_program 'broken[(]re' anything search filter],[10],[ignore],[ignore])

check_rexp_h([test_program haystack needle match filter],[20],[ignore],[ignore])
check_rexp_h([test_program haystack hay match filter],[20],[ignore],[ignore])

check_rexp_h([test_program 'hay(stack)?' hay match filter],[0],
[0: 0 3 |hay|
1: -1 -1 |(NULL)|
2: -1 -1 |(NULL)|
],[stderr_text(filter)])

check_rexp_h([test_program hay haystack match filter],[0],
[0: 0 3 |hay|
1: -1 -1 |(NULL)|
],[stderr_text(filter)])

check_rexp_h([test_program '((hay)(stack){2})' haystackstack match filter],[0],
[0: 0 13 |haystackstack|
1: 0 13 |haystackstack|
2: 0 3 |hay|
3: 8 13 |stack|
4: -1 -1 |(NULL)|
],[stderr_text(filter)])

check_rexp_h([test_program haystack needle search filter],[20],[ignore],[ignore])
check_rexp_h([test_program haystack hay search filter],[20],[ignore],[ignore])

check_rexp_h([test_program 'hay(stack)?' hay search filter],[0],
[0: 0 3 |hay|
1: -1 -1 |(NULL)|
2: -1 -1 |(NULL)|
],[stderr_text(filter)])

check_rexp_h([test_program hay haystack search filter],[0],
[0: 0 3 |hay|
1: -1 -1 |(NULL)|
],[stderr_text(filter)])

check_rexp_h([test_program '((hay)(stack){2})' haystackstack search filter],[0],
[0: 0 13 |haystackstack|
1: 0 13 |haystackstack|
2: 0 3 |hay|
3: 8 13 |stack|
4: -1 -1 |(NULL)|
],[stderr_text(filter)])

check_rexp_h([test_program haystack Xneedle match filter],[20],[ignore],[ignore])
check_rexp_h([test_program haystack Xhay match filter],[20],[ignore],[ignore])
check_rexp_h([test_program 'hay(stack)?' Xhay match filter],[20],[ignore],[ignore])
check_rexp_h([test_program hay Xhaystack match filter],[20],[ignore],[ignore])
check_rexp_h([test_program '((hay)(stack){2})' Xhaystackstack match filter],[20],[ignore],[ignore])

check_rexp_h([test_program haystack Xneedle search filter],[20],[ignore],[ignore])
check_rexp_h([test_program haystack Xhay search filter],[20],[ignore],[ignore])

check_rexp_h([test_program 'hay(stack)?' Xhay search filter],[0],
[0: 1 4 |hay|
1: -1 -1 |(NULL)|
2: -1 -1 |(NULL)|
],[stderr_text(filter)])

check_rexp_h([test_program hay Xhaystack search filter],[0],
[0: 1 4 |hay|
1: -1 -1 |(NULL)|
],[stderr_text(filter)])

check_rexp_h([test_program '((hay)(stack){2})' Xhaystackstack search filter],[0],
[0: 1 14 |haystackstack|
1: 1 14 |haystackstack|
2: 1 4 |hay|
3: 9 14 |stack|
4: -1 -1 |(NULL)|
],[stderr_text(filter)])

m4_if([test_program],[test_rexp_h_u8],
[
check_rexp_h_utf8([test_program '[[ŝ]]' 'Eĥoŝanĝo ĉiuĵaŭde' search filter],[0],
[0: 4 6 |ŝ|
1: -1 -1 |(NULL)|
],[stderr_text(filter)])
])

])
])

//-------------------------------------------------------------------------
